[toc]

# 多用户通信系统

## 需求分析

![](../images/Java多用户通信系统需求分析.png)

## 功能实现

### 用户登录

- 功能说明

  因为还没学学习数据库, 所以我们人为规定 用户名 / id = 100, 密码 = 123456 就可以登录,其他用户不能登录,后面使用 HashMap 模拟数据库,可以多个用户登录

- 思路分析 + 程序框架图

- 代码实现

### 拉取在线用户

### 无异常退出

**因为客户端在主线程启用了另一个线程，当主线程结束时，另一个线程正在运行，所以进程不会结束**

#### 解决方法

- 客户端
  1. 在 main 线程调用方法，给服务器端发送一个退出系统的 message 对象
  2. 调用 `System.exit(0)` 正常退出 
- 服务器端
  1. 服务器和某个客户端通讯的线程，如果接受到了一个退出系统的 message 后
  2. 把这个线程持有的 `socket` 关闭
  3. 退出该线程的 run 方法 ( 退出 while 循环, 就相当于退出了线程 )

### 私聊

- 客户端
  1. 接收用户希望给某个其他在线用户聊天的内容
  2. 将消息构建成一个 message 对象，通过对应的 socket 发送给服务器
  3. 在它的线程 ( 通信线程中 )，读取到发送的 message 消息，并显示即可
- 服务器端
  1. 可以读取到客户端发送给某个客户的消息
  2. 从管理线程的集合中，根据 message 对象的 getter 获取到对应线程的 socket
  3. 然后将 message 对象转发给指定客户

### 群发消息

### 发文件

- 客户端
  1. 先把文件A 读取到客户端【字节数组】
  2. 把文件对应的字节数组封装到 message 对象 【包含文件内容，sender，getter】
  3. 将 message 对象发送给服务器端
  4. 再接收到包含有文件的消息后，就将该文件保存到磁盘上
- 服务器端
  1. 接收到 message 对象
  2. 拆解 message 对象的 getter，获取该用户的通信线程
  3. 将 message 对象转发给指定用户

### 服务器推送消息

- 服务器
  1. 推送消息 / 新闻,本质其实就是群发消息
  2. 在服务器端启动一条独立的线程,专门负责推送消息

### 扩展功能

#### 离线留言

如果某个用户没有在线,当登录后,可以接受离线的消息

#### 离线发文件

如果某个用户没有在线,当登录后,可以接受离线的文件